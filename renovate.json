{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "helpers:pinGitHubActionDigests",
    "helpers:pinGitHubActionDigestsToSemver"
  ],
  "enabledManagers": [
    "custom.regex",
    "github-actions"
  ],
  "ignorePaths": [],
  "kubernetes": {
    "description": [
      " Update container image tags in Kubernetes manifests installed via",
      " 'kumactl install demo|observability'. Limits matching to the generated YAML under",
      " app/kumactl/data/install/k8s/"
    ],
    "managerFilePatterns": ["/app/kumactl/data/install/k8s/.+\\.ya?ml$/"]
  },
  "customManagers": [
    {
      "customType": "regex",
      "managerFilePatterns": [
        "/(^|/)(workflow-templates|\\.(?:github|gitea|forgejo)/(?:workflows|actions))/.+\\.ya?ml$/",
        "/(^|/)action\\.ya?ml$/"
      ],
      "matchStrings": [
        "(?<packageName>Kong\\/public-shared-actions\\/(?:[0-9A-Za-z._-]*\\/)*(?<depName>[^\\s@]+))@(?:(?<currentDigest>[0-9A-Fa-f]{7,40})[#\\t ]*#[\\t ]*)?v?(?<currentValue>[4-9][0-9]*(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?)(?<indentation>\\s|$)"
      ],
      "extractVersionTemplate": "^@?(?:[0-9A-Za-z._-]*\\/)*{{{depName}}}[@_]v?(?<version>[0-9]+(?:\\.[0-9]+){0,3}(?:-[0-9A-Za-z.-]+)?)$",
      "autoReplaceStringTemplate": "{{{packageName}}}@{{#if newDigest}}{{{newDigest}}} # {{{prettyNewVersion}}}{{else}}{{{newValue}}}{{/if}}{{{indentation}}}",
      "datasourceTemplate": "github-tags",
      "versioningTemplate": "semver-coerced"
    }
  ],
  "packageRules": [
    {
      "description": [
        " Manage Kong/public-shared-actions updates using the custom manager, so disable the default",
        " GitHub Actions manager for these"
      ],
      "matchPackageNames": ["Kong/public-shared-actions"],
      "matchManagers": ["github-actions"],
      "matchCurrentValue": "!/^v?[0-2](?:\\.[0-9]+){0,2}$/",
      "enabled": false
    },
    {
      "description": [
        " Do not pin SLSA-GitHub-Generator by digest. The project publishes versioned tags and",
        " explicitly recommends disabling digest pinning for Renovate so updates track tags only.",
        " Pinning to a commit SHA can break provenance and reusability expectations of the generator",
        " and will fight with the upstream release /tag workflow",
        " More info: https://github.com/slsa-framework/slsa-github-generator/blob/main/RENOVATE.md"
      ],
      "matchManagers": ["github-actions"],
      "matchPackageNames": ["slsa-framework/slsa-github-generator"],
      "pinDigests": false
    },
    {
      "description": [
        " Ensure commit and PR titles use the full package name for better clarity. Prevent",
        " lowercase conversion of the package name to keep `Kong` correctly capitalized. Set commit",
        " actions to use lowercase (e.g., `update`, `pin`, `replace`, `roll back`). Also update",
        " the PR body table to reflect the full name and include a link to the source code"
      ],
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "commitMessageTopic": "{{{packageName}}}",
      "commitMessageLowerCase": "never",
      "commitMessageAction": "bump",
      "pin": {"commitMessageAction": "pin"},
      "pinDigest": {"commitMessageAction": "pin"},
      "replacement": {"commitMessageAction": "replace"},
      "rollback": {"commitMessageAction": "roll back"},
      "prBodyDefinitions": {
        "Package": "[{{{packageName}}}]({{{sourceUrl}}}) ([source]({{{sourceUrl}}}/tree/{{#if newVersion}}%40{{{depName}}}%40{{{newVersion}}}{{else}}{{#if newDigest}}{{{newDigest}}}{{else}}main{{/if}}{{/if}}/{{{depName}}}))"
      }
    },
    {
      "description": [
        " Standardize commit messages to use 'from ... to ...' notation for version and digest",
        " changes across all dependencies. This mirrors Dependabot's style so downstream automation",
        " (e.g., changelog generation) remains compatible"
      ],
      "matchPackageNames": ["**"],
      "commitMessageTopic": "{{{depName}}}{{#if (and (equals updateType 'digest') (equals currentValue newValue) newValue)}}:{{{newValue}}}{{/if}}",
      "commitMessageExtra": "{{#if (or (and (or isMajor isMinor isPatch) (or (and isSingleVersion currentVersion) currentValue currentDigestShort)) (and (equals updateType 'digest') currentDigestShort))}}from {{#if (equals updateType 'digest')}}{{{currentDigestShort}}}{{else}}{{#if isSingleVersion}}{{currentVersion}}{{else}}{{#if currentValue}}{{{currentValue}}}{{else}}{{{currentDigestShort}}}{{/if}}{{/if}}{{/if}} {{/if}}to {{#if (or isPinDigest (equals updateType 'digest'))}}{{{newDigestShort}}}{{else}}{{#if isSingleVersion}}{{newVersion}}{{else}}{{#if newValue}}{{{newValue}}}{{else}}{{{newDigestShort}}}{{/if}}{{/if}}{{/if}}"
    },
    {
      "matchManagers": ["custom.regex"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "pinDigests": true
    },
    {
      "description": [
        " Enforce digest pinning for Kong/public-shared-actions sub-actions. This rule prioritizes",
        " and always recreates PRs that pin or refresh commit digests for these actions, bypassing",
        " normal schedules and Renovate rate limits so repositories get secure, updatable references",
        " immediately",
        "",
        " Why: This monorepo now publishes per-sub-action tags like '<name>@<version>'",
        " (e.g., 'workflow-notification@4.0.1') rather than simple 'vX.Y.Z' tags. Repositories",
        " using '...@v2' cannot be auto-migrated to the new tag names without changing",
        " the reference format (which would look like '...@workflow-notification@4.0.1'). Digest",
        " pinning avoids the tag-name mismatch entirely because Renovate tracks and updates",
        " by commit SHA and adds a friendly '# vX.Y.Z' comment for humans"
      ],
      "matchDepTypes": ["action"],
      "matchUpdateTypes": ["pinDigest"],
      "matchPackageNames": ["Kong/public-shared-actions/**"],
      "matchCurrentValue": "/^v?[0-2](?:\\.[0-9]+){0,2}/",
      "extends": [":disableRateLimiting", ":prImmediately"],
      "groupName": "Pin Kong/public-shared-actions/**",
      "groupSlug": "kong-public-shared-actions",
      "commitMessageAction": "pin",
      "commitMessageTopic": "Kong/public-shared-actions",
      "commitMessageExtra": "",
      "additionalBranchPrefix": "pin/",
      "updateNotScheduled": true,
      "recreateWhen": "always",
      "schedule": ["at any time"],
      "dependencyDashboardApproval": false,
      "minimumReleaseAge": null,
      "prHeader": "> [!CAUTION]\n> This PR pins `Kong/public-shared-actions` to commit digests and is prioritized (bypasses schedules/rate limits). **It will be re-created until merged**\n>\n\n---",
      "prBodyNotes": [
        "---\n> [!NOTE]\n> #### Why digest pinning is required for `Kong/public-shared-actions`\n>\n> `Kong/public-shared-actions` changed release tagging: sub-actions are released with tags in the form `<sub-action-name>@<version>` (not plain `vX.Y.Z`). For example, projects that used `.../slack-actions/workflow-notification` and any other sub-actions previously referenced with plain version tags like `vX...` or `X...` (i.e., `v2`) cannot be auto-updated by tag alone, because the correct tag  `workflow-notification@4.0.1`, which would require `.../workflow-notification@workflow-notification@4.0.1`. With digest pinning, Renovate looks up the tag and records its commit SHA, so the tag name shape no longer matters.\n>\n> **GitHub Actions security guidance advises pinning third-party actions to a full commit SHA to protect against tag moving and supply-chain attacks.**\n>\n> #### References\n>\n> - [GitHub Docs: Security hardening, pin to commit SHA](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions)"
      ]
    }
  ]
}
